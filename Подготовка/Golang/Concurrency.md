–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [The Go Memory Model](https://go.dev/ref/mem)

---

# –ß—Ç–æ —Ç–∞–∫–æ–µ goroutine?

–ì–æ—Ä—É—Ç–∏–Ω—ã (–∫–æ—Ä—É—Ç–∏–Ω—ã, _–≤ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö_) ‚Äî —ç—Ç–æ –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ ¬´–ø–æ—Ç–æ–∫–∏¬ª, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ **—Ä–∞–Ω—Ç–∞–π–º–æ–º Go**, –∞ –Ω–µ –û–°. –û–Ω–∏ —Ç—Ä–µ–±—É—é—Ç –º–∏–Ω–∏–º—É–º —Ä–µ—Å—É—Ä—Å–æ–≤:

- –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞: **2 –ö–ë** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Ç–µ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
- –°–æ–∑–¥–∞—é—Ç—Å—è –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –≤ **–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤).

## –†–∞–∑–ª–∏—á–∏–µ —Å –ø–æ—Ç–æ–∫–æ–º?

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å **–æ—Ç–ª–∏—á–∏–µ –≤ –ª–µ–≥–∫–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç–∏**. 

- –û–Ω–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è runtime-–æ–º Go, –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ user space (—É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–∞–º–∏–º —è–∑—ã–∫–æ–º).
- –£ –Ω–∏—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π stack, –º–æ–∂–µ—Ç –∫–∞–∫ —Ä–∞—Å—Ç–∏, —Ç–∞–∫ –∏ —Å—É–∂–∞—Ç—å—Å—è. 
- –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø–æ—Ç–æ–∫–æ–≤, –æ–Ω–∏ —Ç—Ä–µ–±—É—é—Ç –≥–æ—Ä–∞–∑–¥–æ –º–µ–Ω—å—à–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏.

–í –∏—Ç–æ–≥–µ:
- **–ü–æ—Ç–æ–∫–∏** ‚Äî —Ç—è–∂–µ–ª—ã–µ, —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –û–°, –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —è–¥–µ—Ä.
- **–ì–æ—Ä—É—Ç–∏–Ω—ã** ‚Äî –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ, —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è Go, –∏–¥–µ–∞–ª—å–Ω—ã –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–º–Ω–æ–≥–æ –∑–∞–¥–∞—á —Å I/O).
- **GMP-–º–æ–¥–µ–ª—å** –ø–æ–∑–≤–æ–ª—è–µ—Ç Go –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã –≥–æ—Ä—É—Ç–∏–Ω –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–º —á–∏—Å–ª–µ –ø–æ—Ç–æ–∫–æ–≤ –û–°, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.

### –ü–æ—á–µ–º—É –≥–æ—Ä—É—Ç–∏–Ω—ã ¬´–±—ã—Å—Ç—Ä—ã–µ¬ª?

- **–î–µ—à–µ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ**:
```go
// –ê–ª–ª–æ–∫–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç ~300 –Ω—Å (–≤ 1000 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Ç–æ–∫–æ–≤).
go func() { ... }
```
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**:
	- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏ –∑–∞–Ω–∏–º–∞–µ—Ç ~100 –Ω—Å (–Ω–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —è–¥—Ä–∞).
	- –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º Go, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é** –∏ **–≤—ã—Ç–µ—Å–Ω—è—é—â—É—é** –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å.
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**:
	- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã –≥–æ—Ä—É—Ç–∏–Ω –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –û–°.

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –∏ –≥–æ—Ä—É—Ç–∏–Ω

| **–ö—Ä–∏—Ç–µ—Ä–∏–π**            | **–ü–æ—Ç–æ–∫ –û–°**                | **–ì–æ—Ä—É—Ç–∏–Ω–∞**                     |
| ----------------------- | --------------------------- | -------------------------------- |
| **–ü–∞–º—è—Ç—å –Ω–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä** | 1‚Äì8 –ú–ë                      | 2 –ö–ë ‚Üí –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Ç–µ—Ç        |
| **–°–æ–∑–¥–∞–Ω–∏–µ**            | –ú–µ–¥–ª–µ–Ω–Ω–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã) | –ë—ã—Å—Ç—Ä–æ (—Ä–∞–Ω—Ç–∞–π–º Go)              |
| **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**        | 1‚Äì10 –º–∫—Å (–∫–æ–Ω—Ç–µ–∫—Å—Ç —è–¥—Ä–∞)    | ~100 –Ω—Å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º) |
| **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**         | –û–°                          | –†–∞–Ω—Ç–∞–π–º Go (GMP-–º–æ–¥–µ–ª—å)          |
| **–ú–∞–∫—Å–∏–º—É–º**            | ~10 000 (–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ)       | –ú–∏–ª–ª–∏–æ–Ω—ã                         |

## –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã —É goroutine –∏ –ø–æ—Ç–æ–∫–∞?

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–∫–∞ –û–° (OS Thread Context)

#### –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

- **–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤**: 
	- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–æ–±—ã—á–Ω–æ **1‚Äì8 –ú–ë**, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –û–°, –≤ **Linux 8 –ú–ë**).
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 
	- –†–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (—Ä–µ–∞–ª—å–Ω—ã–µ), —É–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç–µ–∫–∞, —Ñ–ª–∞–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.
- **–°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã**: 
	- –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —Ñ–∞–π–ª–æ–≤, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ—Ç–æ–∫–∞ (TID).
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û–°**: 
	- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–° —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç CPU.

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ü–æ—Ç–æ–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **—è–¥—Ä–æ–º –û–°** (–Ω–∞–ø—Ä–∏–º–µ—Ä, Linux, Windows).
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ —Ç—Ä–µ–±—É–µ—Ç **–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —è–¥—Ä–∞** (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã).

#### –ü—Ä–∏–º–µ—Ä

**–ù–∞ —è–∑—ã–∫–µ C**, –¥–ª—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏:

```c
#include <pthread.h>
void* task(void* arg) {
    printf("Hello from OS thread!");
    return NULL;
}
int main() {
    pthread_t thread;
    pthread_create(&thread, NULL, task, NULL);
    pthread_join(thread, NULL);
    return 0;
}
```

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –≥–æ—Ä—É—Ç–∏–Ω—ã (Goroutine Context)

#### –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

- **–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤**: 
	- –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî **2 –ö–ë**, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
	- –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –∫–æ–¥–µ (—Å—á–µ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥), —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ).
- **–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
	- –ö–∞–Ω–∞–ª—ã, `defer`-–≤—ã–∑–æ–≤—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏, –º–µ—Ç–∫–∏ –¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞.
- **–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**:
	- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, –≤ –∫–∞–∫–æ–º –ø–æ—Ç–æ–∫–µ –û–° (**M**) –∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ (**P**) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≥–æ—Ä—É—Ç–∏–Ω–∞.

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ì–æ—Ä—É—Ç–∏–Ω—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º Go** (–Ω–µ –û–°).
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ** (–±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤).

#### –ü—Ä–∏–º–µ—Ä

```go
go func() { 
    fmt.Println("Hello from goroutine!") 
}()
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ (Go –∏ –û–°)

|**–ö—Ä–∏—Ç–µ—Ä–∏–π**|**–ì–æ—Ä—É—Ç–∏–Ω–∞**|**–ü–æ—Ç–æ–∫ –û–°**|
|---|---|---|
|**–°–æ–∑–¥–∞–Ω–∏–µ**|~300 –Ω—Å, –Ω–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤|~10‚Äì100 –º–∫—Å, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã|
|**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**|~100 –Ω—Å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º)|~1‚Äì10 –º–∫—Å (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–¥—Ä–∞)|
|**–ü–∞–º—è—Ç—å –Ω–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä**|2 –ö–ë (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫)|1‚Äì8 –ú–ë (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–µ–∫)|
|**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**|–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go (GMP-–º–æ–¥–µ–ª—å)|–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–°|
|**–ú–∞–∫—Å–∏–º—É–º**|–ú–∏–ª–ª–∏–æ–Ω—ã (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ RAM)|~10 000 (–ª–∏–º–∏—Ç—ã –û–°)|

## –£—Ç–µ—á–∫–∞ –≥–æ—Ä—É—Ç–∏–Ω

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Goroutine Leaks](https://medium.com/german-gorelkin/goroutine-leaks-bcf3bbb59997)

**–£—Ç–µ—á–∫–∞ –≥–æ—Ä—É—Ç–∏–Ω** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è**, –æ—Å—Ç–∞–≤–∞—è—Å—å "–≤–∏—Å–µ—Ç—å" –≤ –ø–∞–º—è—Ç–∏.  
–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

- **–†–æ—Å—Ç—É –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏** (–∫–∞–∂–¥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–∏–Ω–∏–º—É–º 2 –ö–ë —Å—Ç–µ–∫–∞).
- **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ Go**, –µ—Å–ª–∏ —É—Ç–µ—á–µ–∫ —Ç—ã—Å—è—á–∏.
- **–°–Ω–∏–∂–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –∏ –≤–æ–∑–º–æ–∂–Ω—ã–º —Å–±–æ—è–º.

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–ì–æ—Ä—É—Ç–∏–Ω–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–Ω–∞–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É—Ç).
2. **–ö–∞–Ω–∞–ª –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è**, –∏ –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤–∏—Å–µ—Ç—å –≤ `range` –∏–ª–∏ `select`.
3. **–ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç–º–µ–Ω—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

1. –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –∫–∞–Ω–∞–ª—ã.
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `context` –∏ `select` —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏.
3. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –≥–æ—Ä—É—Ç–∏–Ω—ã —á–µ—Ä–µ–∑ `WaitGroup`.

### –ö–∞–∫ –∏—Å–∫–∞—Ç—å —É—Ç–µ—á–∫–∏

> "–ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞ –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Äî –ø—Ä–æ–¥—É–º–∞–π—Ç–µ, –∫–∞–∫ –æ–Ω–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è."  
‚Äî _–§–∏–ª–æ—Å–æ—Ñ–∏—è Go_ üöÄ

1. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≥–æ—Ä—É—Ç–∏–Ω** (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `defer` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).
2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω** (—á–µ—Ä–µ–∑ `runtime.NumGoroutine()` –∏–ª–∏ `pprof`).
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `go run -race`** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≥–æ–Ω–∫–∏ (–∏–Ω–æ–≥–¥–∞ —É—Ç–µ—á–∫–∏ —Å–≤—è–∑–∞–Ω—ã —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏).

```go
func main() {
    go debugLeakTracker()
    // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}

func debugLeakTracker() {
    for {
        fmt.Println("–¢–µ–∫—É—â–µ–µ –∫–æ–ª-–≤–æ –≥–æ—Ä—É—Ç–∏–Ω:", runtime.NumGoroutine())
        time.Sleep(2 * time.Second)
    }
}
```

# –ü—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–í –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ–≥–æ—Ä—É—Ç–∏–Ω–Ω—ã—Ö —Å—Ä–µ–¥–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã:

- **–ú—å—é—Ç–µ–∫—Å—ã (Mutex)**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—â–µ–º—É —Ä–µ—Å—É—Ä—Å—É.
- **RWMutex (Read-Write Mutex)**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º—å—é—Ç–µ–∫—Å –¥–ª—è —á–∞—Å—Ç–æ–≥–æ —á—Ç–µ–Ω–∏—è.
- **–°–µ–º–∞—Ñ–æ—Ä—ã (Semaphore)**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å—É –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π".
- **–ö–∞–Ω–∞–ª—ã (Channels)**: –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è + –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö).
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Atomic)**: –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ç–∏–ø–æ–≤ (int, pointer).
- **–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Cond)**: –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è —Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –º—å—é—Ç–µ–∫—Å–∞.
- **–ì—Ä—É–ø–ø—ã –æ–∂–∏–¥–∞–Ω–∏—è (WaitGroup)**: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –≥–æ—Ä—É—Ç–∏–Ω.

## –ö–∞–∫–∏–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã –µ—Å—Ç—å –≤ Go?

–í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ Go (`sync` –∏ `sync/atomic`) –¥–æ—Å—Ç—É–ø–Ω—ã:

- **`sync.Mutex`** ‚Äì –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.    
- **`sync.RWMutex`** ‚Äì –º—å—é—Ç–µ–∫—Å —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å.
- **`sync.WaitGroup`** ‚Äì –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω.
- **`sync.Once`** ‚Äì –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞.
- **`sync.Cond`** ‚Äì —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
- **`atomic` (–ø–∞–∫–µ—Ç)** ‚Äì –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Add, CompareAndSwap, Load, Store).
- **–ö–∞–Ω–∞–ª—ã (`chan`)** ‚Äì —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è + –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö.

## –ß—Ç–æ —Ç–∞–∫–æ–µ mutex?

[Source code](https://github.com/golang/go/blob/master/src/sync/mutex.go#L30)

`sync.Mutex` ‚Äì —ç—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤ –¥–ª—è **–≤–∑–∞–∏–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (mutual exclusion)**, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –∫–æ–¥–∞.

```go
// Mutex - —ç—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∑–∞–∏–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
// –ù—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è Mutex - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º—å—é—Ç–µ–∫—Å.
// 
// Mutex –Ω–µ –¥–æ–ª–∂–µ–Ω –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
//
// –í —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ [–º–æ–¥–µ–ª–∏ –ø–∞–º—è—Ç–∏ Go],
// n-–π –≤—ã–∑–æ–≤ [Mutex.Unlock] ¬´—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è¬ª –ø–µ—Ä–µ–¥ m-–º –≤—ã–∑–æ–≤–æ–º [Mutex.Lock] 
// –¥–ª—è –ª—é–±–æ–≥–æ n < m.
// –£—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤ [Mutex.TryLock] —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ–Ω –≤—ã–∑–æ–≤—É Lock.
// –ù–µ—É–¥–∞—á–Ω—ã–π –≤—ã–∑–æ–≤ TryLock –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∏–∫–∞–∫–æ–π —Å–≤—è–∑–∏ ¬´—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–æ¬ª 
// –≤–æ–æ–±—â–µ.
type Mutex struct {
	_ noCopy

	mu isync.Mutex
}

// –õ–æ–∫–µ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å.
type Locker interface {
	Lock()
	Unlock()
}
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏?

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–∞

–í–Ω—É—Ç—Ä–∏ `sync.Mutex` —Å–æ–¥–µ—Ä–∂–∏—Ç:

- `state` (int32) ‚Äì —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –æ–∂–∏–¥–∞—é—â–∏–µ –≥–æ—Ä—É—Ç–∏–Ω—ã.
- `sema` (uint32) ‚Äì —Å–µ–º–∞—Ñ–æ—Ä –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—á–µ—Ä–µ–∑ –û–° –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏).

#### **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã** (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
1. **–ü–æ–ø—ã—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:
   –ì–æ—Ä—É—Ç–∏–Ω–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `Locked` —á–µ—Ä–µ–∑ `atomic.CompareAndSwapInt32`.
   –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Äì –º—å—é—Ç–µ–∫—Å –∑–∞—Ö–≤–∞—á–µ–Ω.
2. **–û–∂–∏–¥–∞–Ω–∏–µ (–µ—Å–ª–∏ –º—å—é—Ç–µ–∫—Å –∑–∞–Ω—è—Ç)**:
   –ì–æ—Ä—É—Ç–∏–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è –∏ "–∑–∞—Å—ã–ø–∞–µ—Ç" (—á–µ—Ä–µ–∑ `runtime.semacquire`).
3. **–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**:
   –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º—å—é—Ç–µ–∫—Å –∏ –±—É–¥–∏—Ç –æ–¥–Ω—É –∏–∑ –∂–¥—É—â–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω (—á–µ—Ä–µ–∑ `runtime.semrelease`).

### –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å mutex –Ω–∞ atomic-–∞—Ö?

–ü—Ä–æ—Å—Ç–µ–π—à–∏–π **—Å–ø–∏–Ω–ª–æ–∫ (spinlock)** –Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö:

```go
type SpinLock struct {
    state *int32
}

const (
    unlocked int32 = 0
    locked   int32 = 1
)

func (s *SpinLock) Lock() {
    for !atomic.CompareAndSwapInt32(s.state, unlocked, locked) {
        // "–ö—Ä—É—Ç–∏—Ç—Å—è" –≤ —Ü–∏–∫–ª–µ, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        runtime.Gosched() // –û—Ç–¥–∞–µ–º CPU, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —è–¥—Ä–æ
    }
}

func (s *SpinLock) Unlock() {
    atomic.StoreInt32(s.state, unlocked)
}
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —Å–ø–∏–Ω–ª–æ–∫–∞**:

- –¢—Ä–∞—Ç–∏—Ç CPU, –ø–æ–∫–∞ –∂–¥–µ—Ç (–ø–ª–æ—Ö–æ –¥–ª—è –¥–æ–ª–≥–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫).
- –í Go —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `sync.Mutex` —É–º–Ω–µ–µ: –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Å–ø–∏–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è.

## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å goroutine, –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ Lock?

1. **–ü–æ–ø—ã—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞**:
   –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—å—é—Ç–µ–∫—Å —Å–≤–æ–±–æ–¥–µ–Ω (`state == 0`). –ï—Å–ª–∏ –¥–∞ ‚Äì –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ.
2. **–û–∂–∏–¥–∞–Ω–∏–µ (–µ—Å–ª–∏ –º—å—é—Ç–µ–∫—Å –∑–∞–Ω—è—Ç)**:
	- –ì–æ—Ä—É—Ç–∏–Ω–∞ **–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è** –º—å—é—Ç–µ–∫—Å–∞.
    - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ **—Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è** (–Ω–µ –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç CPU, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–∑–±—É–∂–µ–Ω–∞).
    - –ü—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (`Unlock()`) –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –±—É–¥–∏—Ç —Å–ª–µ–¥—É—é—â—É—é –≥–æ—Ä—É—Ç–∏–Ω—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏.
3. **–°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (–µ—Å–ª–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –≤—ã—Å–æ–∫–∞—è)**:
   –ï—Å–ª–∏ –±–æ—Ä—å–±–∞ –∑–∞ –º—å—é—Ç–µ–∫—Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Å–µ–º–∞—Ñ–æ—Ä—ã –û–°** (—á–µ—Ä–µ–∑ `runtime.semacquire`).

## –ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã –≤ Go

### `sync.RWMutex` (Read-Write Mutex)

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ "–º–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è, —Ä–µ–¥–∫–æ –∑–∞–ø–∏—Å—å":

```go
var rwMu sync.RWMutex

func read() {
    rwMu.RLock()   // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å
    defer rwMu.RUnlock()
    // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    // ...
}

func write() {
    rwMu.Lock()    // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø–∏—à–µ—Ç
    defer rwMu.Unlock()
    // –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö
    // ...
}
```

### `sync.WaitGroup`

–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –≥–æ—Ä—É—Ç–∏–Ω:

```go
var wg sync.WaitGroup

for i := 0; i < 10; i++ {
    wg.Add(1)
    go func() {
        defer wg.Done()
        // –†–∞–±–æ—Ç–∞ –≥–æ—Ä—É—Ç–∏–Ω—ã
    }()
}

wg.Wait() // –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö
```

### `sync.Once`

–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑:

```go
var once sync.Once

func setup() {
    once.Do(func() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è 1 —Ä–∞–∑)
    })
}
```

### `sync.Cond` (–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)

–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ **–ø–æ–∑–≤–æ–ª—è—é—Ç** –≥–æ—Ä—É—Ç–∏–Ω–∞–º **–æ–∂–∏–¥–∞—Ç—å –∏–ª–∏ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –æ —Å–æ–±—ã—Ç–∏—è—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö **—Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è**.  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –º—å—é—Ç–µ–∫—Å–æ–º (`sync.Mutex` –∏–ª–∏ `sync.RWMutex`).

**–ù–∞–ø—Ä–∏–º–µ—Ä**, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–∞.

#### –ü—Ä–∏–º–µ—Ä

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. –ì–æ—Ä—É—Ç–∏–Ω–∞ 1 –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `cond.Wait()`, –æ—Å–≤–æ–±–æ–∂–¥–∞—è –º—å—é—Ç–µ–∫—Å.
2. –ì–æ—Ä—É—Ç–∏–Ω–∞ 2 –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (`ready = true`) –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `cond.Signal()`.
3. –ì–æ—Ä—É—Ç–∏–Ω–∞ 1 –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è, —Å–Ω–æ–≤–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º—å—é—Ç–µ–∫—Å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ (`!ready`).

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

func main() {
	var (
		mu    sync.Mutex
		cond  = sync.NewCond(&mu)
		ready bool
	)

	// –ì–æ—Ä—É—Ç–∏–Ω–∞-–æ–∂–∏–¥–∞—Ç–µ–ª—å
	go func() {
		mu.Lock()
		for !ready { // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è!
			cond.Wait() // –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º—å—é—Ç–µ–∫—Å –∏ –∂–¥—ë—Ç —Å–∏–≥–Ω–∞–ª–∞
		}
		fmt.Println("–°–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ!")
		mu.Unlock()
	}()

	// –ì–æ—Ä—É—Ç–∏–Ω–∞-—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
	time.Sleep(2 * time.Second)
	mu.Lock()
	ready = true
	cond.Signal() // –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç –æ–¥–Ω—É –≥–æ—Ä—É—Ç–∏–Ω—É (–∏–ª–∏ Broadcast() –¥–ª—è –≤—Å–µ—Ö)
	mu.Unlock()

	time.Sleep(time.Second)
}

// Output:
// –°–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ!
```

### `atomic` (–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)

–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–µ–∑ –º—å—é—Ç–µ–∫—Å–æ–≤. 

–ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: **—Å—á–µ—Ç—á–∏–∫–æ–≤**, **—Ñ–ª–∞–≥–æ–≤** –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Å—Ç—ã—Ö —Ç–∏–ø–æ–≤.

####   –ü—Ä–∏–º–µ—Ä—ã

##### –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Å—á–µ—Ç—á–∏–∫

```go
var (
	counter int32
	wg      sync.WaitGroup
)

for i := 0; i < 100; i++ {
	wg.Add(1)
	go func() {
		atomic.AddInt32(&counter, 1) // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
		wg.Done()
	}()
}

wg.Wait()
fmt.Println("Counter:", counter) // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ 100
```

##### –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Ñ–ª–∞–≥

```go
var (
	flag  int32 // 0 = false, 1 = true
)

// –ì–æ—Ä—É—Ç–∏–Ω–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥
go func() {
	time.Sleep(500 * time.Millisecond)
	atomic.StoreInt32(&flag, 1) // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
}()

// –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞
for atomic.LoadInt32(&flag) == 0 {
	fmt.Println("–û–∂–∏–¥–∞–µ–º...")
	time.Sleep(100 * time.Millisecond)
}
fmt.Println("–§–ª–∞–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
```

### –ö–∞–Ω–∞–ª—ã (Channels)

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è + –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö:

```go
ch := make(chan int)

go func() {
    ch <- 42  // –û—Ç–ø—Ä–∞–≤–∫–∞
}()

val := <-ch  // –ü–æ–ª—É—á–µ–Ω–∏–µ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥—É—Ç –¥–∞–Ω–Ω—ã–µ)
```

### `sync.Map` (–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∞–ø–∞)

–î–ª—è —Ä–µ–¥–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏ —á–∞—Å—Ç—ã—Ö —á—Ç–µ–Ω–∏–π –≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π —Å—Ä–µ–¥–µ. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è `map` + `Mutex` —á–∞—Å—Ç–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

```go
var sm sync.Map

// –ó–∞–ø–∏—Å—å (–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è)
sm.Store("key1", 100)
sm.Store("key2", 200)

// –ß—Ç–µ–Ω–∏–µ
if val, ok := sm.Load("key1"); ok {
	fmt.Println("key1:", val) // 100
}

// –£–¥–∞–ª–µ–Ω–∏–µ
sm.Delete("key2")

// –ò—Ç–µ—Ä–∞—Ü–∏—è
sm.Range(func(key, val any) bool {
	fmt.Printf("%v: %v\n", key, val)
	return true // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Ç–µ—Ä–∞—Ü–∏—é
})
```


#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤–∞ —É—Ä–æ–≤–Ω—è –¥–∞–Ω–Ω—ã—Ö**: "read" (–¥–ª—è —á–∞—Å—Ç–æ–≥–æ —á—Ç–µ–Ω–∏—è) –∏ "dirty" (–¥–ª—è —Ä–µ–¥–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π).
- –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö —á—Ç–µ–Ω–∏—è—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—á—Ç–∏ –∫–∞–∫ –æ–±—ã—á–Ω–∞—è –º–∞–ø–∞ (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫).
- –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–¥–∫–∏–µ –º—å—é—Ç–µ–∫—Å—ã.

##### –ü–ª—é—Å—ã

- - –í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è "—Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å" –ø—Ä–∏ –∑–∞–ø–∏—Å–∏.

##### –ú–∏–Ω—É—Å—ã

- –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç `map` + `Mutex` –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π.
- –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞ –ø–∞–º—è—Ç—å—é (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `sync.Pool`).
- –í `sync.Map` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ `any` –∑–Ω–∞—á–µ–Ω–∏—è —Å type cast-–æ–º, —á—Ç–æ **–º–æ–∂–µ—Ç** –Ω–µ—Å—Ç–∏ —Ä–∏—Å–∫–∏ –ø–∞–Ω–∏–∫–∏ –≤ production.

#### –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ `sync.Map`, –µ—Å–ª–∏ –µ—Å—Ç—å map + mutex

`sync.Map` - **—ç—Ç–æ –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π** (_[–æ—Ç–≤–µ—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](https://github.com/golang/go/blob/master/src/sync/map.go#L13-L39)_).¬†–í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–º —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—ã—á–Ω–æ map + mutex.

–ï—Å–ª–∏ –≤—Å—ë-—Ç–∞–∫–∏ –∑–∞—Ö–æ—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ —Ç–æ–º, —á—Ç–æ `sync.Map` –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è 2 –∫–µ–π—Å–æ–≤:
1. –ö–æ–≥–¥–∞ map - —ç—Ç–æ **–∫—ç—à**.
	1. –¢.–µ. –∫–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∏—à–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑ —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è.
2. –ö–æ–≥–¥–∞ —Ä–∞–∑–Ω—ã–µ goroutine —Ä–∞–±–æ—Ç–∞—é—Ç —Å **–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–º–∏—Å—è –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–∞–º–∏ –∫–ª—é—á–µ–π** `sync.Map`.
	2. –¢.–µ.: –∫–æ–≥–¥–∞ –µ—Å—Ç—å –Ω–∞–ø—Ä–∏–º–µ—Ä **3 —à—Ç. goroutine** –∏ —É –Ω–∏—Ö –≤—Å–µ—Ö –µ—Å—Ç—å **1** `sync.Map`, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –∫–∞–∂–¥–æ–π goroutine –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã** (–º–Ω–æ–∂–µ—Å—Ç–≤–æ) **–∫–ª—é—á–µ–π** (–∫–∞–∂–¥–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ—ë –º–Ω–æ–∂–µ—Å—Ç–≤–æ).

–í —ç—Ç–∏—Ö –¥–≤—É—Ö —Å–ª—É—á–∞—è—Ö –º—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–∏–≥—Ä–∞–µ–º –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏, –µ—Å–ª–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—É—é map + mutex.

##### –ü—Ä–∞–≤–∏–ª–æ: "–û—á–µ–Ω—å –º–Ω–æ–≥–æ —á—Ç–µ–Ω–∏–π, —Ä–µ–¥–∫–æ ‚Äî –∑–∞–ø–∏—Å–∏"

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sync.Map`, –µ—Å–ª–∏ —É –≤–∞—Å:

- **–ß–∞—Å—Ç—ã–µ `Load` (—á—Ç–µ–Ω–∏–µ)** ‚Äî —Ç—ã—Å—è—á–∏ –∏–ª–∏ –º–∏–ª–ª–∏–æ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É.
- **–†–µ–¥–∫–∏–µ `Store` (–∑–∞–ø–∏—Å—å)** ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –∏–ª–∏ —Ä–µ–∂–µ.
- **–ù–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ 100% –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (–∏–∑-–∑–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ `sync.Map`).

##### –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è `sync.Map`

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π**, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ä–µ–¥–∫–æ (—Ä–∞–∑ –≤ —á–∞—Å/–¥–µ–Ω—å).
2. **–°—á–µ—Ç—á–∏–∫–∏ –º–µ—Ç—Ä–∏–∫** –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (—á–∞—Å—Ç—ã–µ —á—Ç–µ–Ω–∏—è, —Ä–µ–¥–∫–∏–µ —Å–±—Ä–æ—Å—ã).
3. **Lookup-—Ç–∞–±–ª–∏—Ü—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –≤–∞–ª—é—Ç –∏–ª–∏ —Å—Ç—Ä–∞–Ω).

##### –ö–æ–≥–¥–∞ `map + Mutex` –ª—É—á—à–µ?

**–ö–æ—Ä–æ—Ç–∫–æ**

- –í—ã–±–µ—Ä–∏—Ç–µ `sync.Map` –µ—Å–ª–∏:  
    **–ß—Ç–µ–Ω–∏—è** >> **–ó–∞–ø–∏—Å–∏** (—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚â• 100:1).
- –í—ã–±–µ—Ä–∏—Ç–µ `map + RWMutex` –µ—Å–ª–∏:  
    –ó–∞–ø–∏—Å–∏ —á–∞—Å—Ç—ã–µ –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–∞–º—è—Ç—å—é.

> "–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å ‚Äî —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ—é –Ω–∞–≥—Ä—É–∑–∫—É. `sync.Map` ‚Äî —É–∑–∫–æ—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ –∑–∞–º–µ–Ω–∞ –≤—Å–µ–º –º–∞–ø–∞–º."  
> ‚Äî _–°–æ–≤–µ—Ç –∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã Go_

**–ü–æ–¥—Ä–æ–±–Ω–æ**

–û–±—ã—á–Ω–∞—è `map` —Å –º—å—é—Ç–µ–∫—Å–æ–º (`sync.Mutex` –∏–ª–∏ `sync.RWMutex`) –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ, –µ—Å–ª–∏:

- –ó–∞–ø–∏—Å–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç **—á–∞—Å—Ç–æ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥).
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π **–Ω–µ–≤–µ–ª–∏–∫–æ** (–º–µ–Ω–µ–µ 1000).
- –¢—Ä–µ–±—É–µ—Ç—Å—è **–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ real-time —Å–∏—Å—Ç–µ–º–∞—Ö).

###### –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è `map + Mutex`

1. **–°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API**, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ.
2. **–ö–µ—à —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**, –≥–¥–µ –∑–∞–ø–∏—Å–∏ –∏–¥—É—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.
3. **–ë—ã—Å—Ç—Ä—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –ø–∞–º—è—Ç–∏).

##### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| **–û–ø–µ—Ä–∞—Ü–∏—è**       | **`sync.Map`**           | **`map + RWMutex`**   |
| ------------------ | ------------------------ | --------------------- |
| **–ß–∞—Å—Ç—ã–µ `Load`**  | ‚ö° –ë—ã—Å—Ç—Ä–æ (lock-free)     | –°—Ä–µ–¥–Ω–µ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)   |
| **–ß–∞—Å—Ç—ã–µ `Store`** | üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ (–∫–æ–ø–ø–∏–Ω–≥)    | ‚ö° –ë—ã—Å—Ç—Ä–æ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏) |
| **–ü–∞–º—è—Ç—å**         | –í—ã—à–µ (–¥–≤–æ–π–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ) | –ù–∏–∂–µ                  |

##### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ `sync.Map`

–ü–æ—á–µ–º—É `sync.Map` –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ —Ä–µ–¥–∫–∏—Ö –∑–∞–ø–∏—Å—è—Ö?

1. **–î–≤–∞ —É—Ä–æ–≤–Ω—è –¥–∞–Ω–Ω—ã—Ö**:
    - `read` (atomic-–¥–æ—Å—Ç—É–ø, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫) ‚Äî –¥–ª—è —á—Ç–µ–Ω–∏—è.
    - `dirty` (—Ç—Ä–µ–±—É–µ—Ç –º—å—é—Ç–µ–∫—Å–∞) ‚Äî –¥–ª—è –∑–∞–ø–∏—Å–∏.
2. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏**:
    - –ï—Å–ª–∏ –≤ `dirty` –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, `read` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ.
3. **"–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ" –∫–ª—é—á–∏**:
    - –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö –∑–∞–ø–∏—Å—è—Ö `sync.Map` –º–æ–∂–µ—Ç –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

##### –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ —Å –±–µ–Ω—á–º–∞—Ä–∫–æ–º (–∫–æ–≥–¥–∞ `sync.Map` –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç)

–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ `sync.Map`:

```go
package main

import (
	"sync"
	"testing"
)

// –¢–µ—Å—Ç –¥–ª—è —á–∞—Å—Ç—ã—Ö —á—Ç–µ–Ω–∏–π –∏ —Ä–µ–¥–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
func BenchmarkSyncMap(b *testing.B) {
	var sm sync.Map
	sm.Store("key", "value")

	for i := 0; i < b.N; i++ {
		sm.Load("key") // 100% —á—Ç–µ–Ω–∏–µ
	}
}

func BenchmarkMutexMap(b *testing.B) {
	var mu sync.RWMutex
	m := make(map[string]string)
	m["key"] = "value"

	for i := 0; i < b.N; i++ {
		mu.RLock()
		_ = m["key"]
		mu.RUnlock()
	}
}

// $ go test -bench=.
//
// Output:
// goos: linux
// goarch: amd64
// pkg: awesomeProject
// cpu: Intel(R) Core(TM) i9-14900K
// BenchmarkSyncMap-32             163039533                6.953 ns/op
// BenchmarkMutexMap-32            100000000               11.38 ns/op
```

### `sync.Pool` (–ü—É–ª –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

**`sync.Pool`** ‚Äî –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ –≤ hot-–∫–æ–¥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞—Ä—Å–∏–Ω–≥ JSON, –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è).

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GC** (—Å–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞) **–ø—Ä–∏ —á–∞—Å—Ç–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—É—Ñ–µ—Ä—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤).

**–í–∞–∂–Ω–æ:**
	–î–ª—è `sync.Pool` –≤—Å–µ–≥–¥–∞ –æ—á–∏—â–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ –ø—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `buf.Reset()`).

#### –ü—Ä–∏–º–µ—Ä

–ü—É–ª –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è —Å—Ç—Ä–æ–∫:

```go
package main

import (
	"bytes"
	"sync"
)

var bufPool = sync.Pool{
	New: func() any {
		return new(bytes.Buffer) // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±—É—Ñ–µ—Ä, –µ—Å–ª–∏ –ø—É–ª –ø—É—Å—Ç
	},
}

func getBuffer() *bytes.Buffer {
	return bufPool.Get().(*bytes.Buffer)
}

func putBuffer(buf *bytes.Buffer) {
	buf.Reset() // –û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
	bufPool.Put(buf)
}

func main() {
	buf := getBuffer()
	defer putBuffer(buf)

	buf.WriteString("Hello, Pool!")
	fmt.Println(buf.String())
}
```

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏

- –ö–∞–∂–¥—ã–π `P` (–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏–∑ GMP) –∏–º–µ–µ—Ç —Å–≤–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –æ–±—ä–µ–∫—Ç–æ–≤.
- –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É–ª –ø—É—Å—Ç ‚Äî –±–µ—Ä–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ –æ–±—â–µ–≥–æ –ø—É–ª–∞ –∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `New()`.
- –û–±—ä–µ–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã —Å–±–æ—Ä—â–∏–∫–æ–º –º—É—Å–æ—Ä–∞ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.

##### –ü–ª—é—Å—ã

- –°–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ GC.
- –£–º–µ–Ω—å—à–∞–µ—Ç –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è "—Ç—è–∂–µ–ª—ã—Ö" –æ–±—ä–µ–∫—Ç–æ–≤.

##### –ú–∏–Ω—É—Å—ã

- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –æ–±—ä–µ–∫—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –ø—É–ª–µ.
- –°–ª–æ–∂–Ω–µ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Ç–µ—á–∫–∏.

# –ü—Ä–æ–±–ª–µ–º—ã –≤ concurrency?

| **–ü—Ä–æ–±–ª–µ–º–∞**       | **–û–ø–∏—Å–∞–Ω–∏–µ**                                        | **–ü—Ä–∏–º–µ—Ä –≤ Go**                    |
| ------------------ | --------------------------------------------------- | ---------------------------------- |
| **Deadlock**       | –í–µ—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞                                   | –î–≤–∞ –º—å—é—Ç–µ–∫—Å–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—è–¥–∫–∞—Ö     |
| **Livelock**       | –ë–µ—Å–ø–æ–ª–µ–∑–Ω–∞—è —Ä–∞–±–æ—Ç–∞                                  | –ì–æ—Ä—É—Ç–∏–Ω—ã "—Ç–æ–ª–∫–∞—é—Ç—Å—è" –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |
| **Data Race**      | –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ –∑–∞–ø–∏—Å—å                               | –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `counter++`   |
| **Race Condition** | –õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ—Ä—è–¥–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (–≥–æ–Ω–∫–∞ –∫ —Ñ–∏–Ω–∏—à—É) | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞ —Ä–∞–Ω—å—à–µ –æ—Ç–ø—Ä–∞–≤–∫–∏    |

## –ß—Ç–æ —Ç–∞–∫–æ–µ Deadlock (–í–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

–°–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –¥–≤–µ –∏–ª–∏ –±–æ–ª–µ–µ –≥–æ—Ä—É—Ç–∏–Ω (–∏–ª–∏ –ø–æ—Ç–æ–∫–æ–≤) **–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞**, –æ–∂–∏–¥–∞—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.

### –ü—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è Deadlock

#### –û—à–∏–±–æ—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–ß–∞—Å—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ deadlock –∫—Ä–æ–µ—Ç—Å—è –≤ –æ—à–∏–±–æ—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∂–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞ –æ—Ç –¥—Ä—É–≥–æ–π, –∫–æ—Ç–æ—Ä–∞—è –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å —Ç–∞–∫–∂–µ –∂–¥–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–µ—Ä–≤–æ–π.

#### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤

–†–∞–±–æ—Ç–∞—è —Å –∫–∞–Ω–∞–ª–∞–º–∏, –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å, —á—Ç–æ–±—ã –ø—Ä–∏–µ–º –±—ã–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ø–µ—Ä–µ–¥–∞—á–µ–π. –ï—Å–ª–∏ –≤ –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç —ç—Ç–æ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ä–∏—Å–∫—É—é—Ç –∑–∞—Å—Ç—Ä—è—Ç—å –≤ deadlock.

#### –ó–∞–±—ã—Ç—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

–ó–∞–±—ã—Ç—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –Ω–µ–≤—ã—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–µ –º—å—é—Ç–µ–∫—Å—ã ‚Äî —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞—Å—Ç–æ–ø–æ—Ä–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –∫–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω—ã–º –∏ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–º.

### –£—Å–ª–æ–≤–∏—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è (–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ 4 —É—Å–ª–æ–≤–∏—è –ö–æ—Ñ—Ñ–º–∞–Ω–∞)

1. **–í–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ** (Mutual Exclusion) ‚Äî —Ä–µ—Å—É—Ä—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–æ–π.
2. **–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ** (Hold and Wait) ‚Äî –≥–æ—Ä—É—Ç–∏–Ω–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å –∏ –∂–¥–µ—Ç –¥—Ä—É–≥–æ–π.
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è** (No Preemption) ‚Äî —Ä–µ—Å—É—Ä—Å –Ω–µ–ª—å–∑—è –æ—Ç–Ω—è—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.
4. **–ö–æ–ª—å—Ü–µ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** (Circular Wait) ‚Äî –≥–æ—Ä—É—Ç–∏–Ω—ã –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –ø–æ –∫—Ä—É–≥—É.

### –ü—Ä–∏–º–µ—Ä

```go
package main

import (
	"fmt"
)

func main() {
	var ch chan int

	// –ì–ª–∞–≤–Ω–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å—á–∏—Ç–∞—Ç—å –∏–∑ –∫–∞–Ω–∞–ª–∞, 
	// –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –ø–∏—à–µ—Ç –∏ –∫–∞–Ω–∞–ª –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
	fmt.Println(<-ch)
}

// Output:
// fatal error: all goroutines are asleep - deadlock!
```

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

- –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–≤—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å—ã –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ).
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `select` —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤.
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `go vet` –∏ `-race` (–¥–µ—Ç–µ–∫—Ç–æ—Ä –≥–æ–Ω–æ–∫) –º–æ–≥—É—Ç –ø–æ–º–æ—á—å.

## –ß—Ç–æ —Ç–∞–∫–æ–µ Live Lock (–õ–æ–∂–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:

- [Livelock: –≤ —á–µ–º, –ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–Ω–∏—Ü–∞ —Å Deadlock](https://www.guru99.com/ru/what-is-livelock-example.html)
- [Deadlocks, Livelocks –∏ Starvation](https://medium.com/german-gorelkin/deadlocks-livelocks-starvation-ccd22d06f3ae)
- 

–ì–æ—Ä—É—Ç–∏–Ω—ã **–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞**, –Ω–æ **–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç**, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º–µ–Ω—è—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

> **Livelock**- —ç—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–æ —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∏–∫–∞–∫ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤–ø–µ—Ä–µ–¥.

### –ü—Ä–∏–º–µ—Ä

–ú—É–∂ –∏ –∂–µ–Ω–∞ –ø—ã—Ç–∞—é—Ç—Å—è –ø–æ—É–∂–∏–Ω–∞—Ç—å, –Ω–æ –º–µ–∂–¥—É –Ω–∏–º–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ª–æ–∂–∫–∞. –ö–∞–∂–¥—ã–π –∏–∑ —Å—É–ø—Ä—É–≥–æ–≤ —Å–ª–∏—à–∫–æ–º –≤–µ–∂–ª–∏–≤, –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –ª–æ–∂–∫—É, –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –µ—â–µ –Ω–µ –µ–ª.

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

type spoon struct {
	owner *diner
}

func (s spoon) use() {
	fmt.Printf("%s has eaten!\n", s.owner.name)
}

type diner struct {
	name     string
	isHungry bool
}

func (d *diner) eatWith(sp *spoon, spouse *diner) {
	for d.isHungry {

		// 1
		if sp.owner != d {
			time.Sleep(1 * time.Second)
			continue
		}

		// 2
		if spouse.isHungry {
			fmt.Printf("%s: You eat first my darling %s!\n", d.name, spouse.name)
			sp.owner = spouse
			continue
		}

		// 3
		sp.use()
		d.isHungry = false
		fmt.Printf("%s: I'm stuffed? my darling %s!\n", d.name, spouse.name)
		sp.owner = spouse
	}
}

func main() {
	husband := &diner{
		name:     "Bob",
		isHungry: true,
	}
	wifi := &diner{
		name:     "Alice",
		isHungry: true,
	}

	sp := &spoon{owner: husband}

	var wg sync.WaitGroup
	wg.Add(2)

	go func() {
		husband.eatWith(sp, wifi)
		wg.Done()
	}()

	go func() {
		wifi.eatWith(sp, husband)
		wg.Done()
	}()

	wg.Wait()
}

// Output:
// Bob: You eat first my darling Alice!
// Alice: You eat first my darling Bob!
// Bob: You eat first my darling Alice!
// Alice: You eat first my darling Bob!
// Bob: You eat first my darling Alice!
// Alice: You eat first my darling Bob!
// ...
// timeout running program
```

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

- –ü–µ—Ä–µ–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
- **–í–æ–∑–º–æ–∂–Ω–æ**: –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (`time.Sleep` —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º).

## –ß—Ç–æ —Ç–∞–∫–æ–µ Data Race

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Data Race Detector](https://go.dev/doc/articles/race_detector)
- [Race condition –∏ Data Race](https://medium.com/german-gorelkin/race-8936927dba20)

–ù–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω **–∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º**, –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö **–∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ**. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ **–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é**.

**–ß–∞—Å—Ç—ã–π –ø—Ä–∏–º–µ—Ä**
–ö–æ–≥–¥–∞ –¥–≤–µ goroutine —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π map –∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ map. –ï—Å–ª–∏ –∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ, –ø—Ä–æ–±–ª–µ–º –Ω–∏–∫–∞–∫–∏—Ö –Ω–µ—Ç.

### –ü—Ä–∏–º–µ—Ä

–°—á–µ—Ç—á–∏–∫ —Å –≥–æ–Ω–∫–æ–π:

```go
var counter int

func increment() {
    counter++ // –ù–µ–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (—á–∏—Ç–∞–µ—Ç, –º–µ–Ω—è–µ—Ç, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç)
}

func main() {
    for i := 0; i < 1000; i++ {
        go increment()
    }
    time.Sleep(1 * time.Second)
    fmt.Println(counter) // –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª—É—á–∞–π–Ω—ã–π (–º–µ–Ω—å—à–µ 1000)
}

// $ go run --race main.go
//
// Output:
// ==================
// WARNING: DATA RACE
// Read at 0x000000______ by goroutine 16:
//   main.increment()
// ....
// ...
// ==================
// 695
// Found 3 data race(s)
// exit status 66
```

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sync.Mutex`, `sync/atomic` –∏–ª–∏ –∫–∞–Ω–∞–ª—ã.

### –ö–∞–∫ –≤—ã—è–≤–∏—Ç—å

–ó–∞–ø—É—Å–∫–∞—Ç—å —Å —Ñ–ª–∞–≥–æ–º `-race`:

```go
# –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –≥–æ–Ω–∫–∏
go run --race main.go
```

## –ß—Ç–æ —Ç–∞–∫–æ–µ Race Condition

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Race condition –∏ Data Race](https://medium.com/german-gorelkin/race-8936927dba20)

–ë–æ–ª–µ–µ –æ–±—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —á–µ–º Data Race. –ü—Ä–æ–≥—Ä–∞–º–º–∞ **–≤–µ–¥–µ—Ç —Å–µ–±—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –∏–∑-–∑–∞ **–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π** (–¥–∞–∂–µ –±–µ–∑ –≥–æ–Ω–∫–∏ –∑–∞ –ø–∞–º—è—Ç—å—é).

**Race condition** –∏ **data race** ‚Äî –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –ø—É—Ç–∞—é—Ç.

**Race condition** ‚Äî —ç—Ç–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–π, –∫–æ–≥–¥–∞ –≤—Ä–µ–º—è –∏–ª–∏ –ø–æ—Ä—è–¥–æ–∫ —Å–æ–±—ã—Ç–∏–π –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã.

**–í–∞–∂–Ω–æ, —á—Ç–æ Race condition ‚Äî —ç—Ç–æ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.**

### –ü—Ä–∏–º–µ—Ä

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø—Ä–∏–º–µ—Ä, –≥–¥–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω:

```go
package main  
  
import "fmt"  
  
func main() {  
    go func() {  
       fmt.Printf("A->")  
    }()  
  
    go func() {  
       fmt.Printf("B")  
    }()  
}
```

–ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–∫–æ–π –∫–æ–¥ –º–Ω–æ–≥–æ —Ä–∞–∑, —Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:

```
A->B  
A->B  
A->B  
A->B  
BA->
A->B
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω. –≠—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ race condition. –°–∏—Ç—É–∞—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≥–æ—Ä–∞–∑–¥–æ —Å–ª–æ–∂–Ω–µ–π –∏ –Ω–µ –æ—á–µ–≤–∏–¥–Ω–µ–π.

**–£—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ race condition —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –Ω–µ—Ç –æ–±—â–µ–≥–æ —Å–ø–æ—Å–æ–±–∞ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –æ–±—â–µ–º —Å–ª—É—á–∞–µ.**

–ü–æ–º–æ—á—å –º–æ–≥—É—Ç —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª—ã, –º—å—é—Ç–µ–∫—Å—ã –∏–ª–∏ `sync.WaitGroup`.
- –ß–µ—Ç–∫–æ–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π.

## –î—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã Concurrency

### –ì–æ–ª–æ–¥–∞–Ω–∏–µ (Starvation)

–ì–æ—Ä—É—Ç–∏–Ω–∞/–ø–æ—Ç–æ–∫ **–Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å—É**, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥—Ä—É–≥–∏–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –µ–≥–æ –º–æ–Ω–æ–ø–æ–ª–∏–∑–∏—Ä—É—é—Ç.

–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞).

#### –ü—Ä–∏—á–∏–Ω—ã

- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
- –û–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º—å—é—Ç–µ–∫—Å).

#### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sync.RWMutex` (–µ—Å–ª–∏ –º–Ω–æ–≥–æ —á—Ç–µ–Ω–∏–π).
- –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞.

### –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (Busy Waiting)

**Busy Waiting (–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ)** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –≤ —Ü–∏–∫–ª–µ, **—Ç—Ä–∞—Ç—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è**, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã "—É—Å–Ω—É—Ç—å" –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –¥—Ä—É–≥–∏–º –≥–æ—Ä—É—Ç–∏–Ω–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å.

–ù–∞–ø—Ä–∏–º–µ—Ä, –≥–æ—Ä—É—Ç–∏–Ω–∞ —Ç—Ä–∞—Ç–∏—Ç CPU –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å–ª–æ–≤–∏—è (–ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sync.Cond`).

#### –ü—Ä–∏–º–µ—Ä—ã

##### –ü—Ä–∏–º–µ—Ä 1: –ü–ª–æ—Ö–æ–π –∫–æ–¥ (Busy Waiting)

–ì–æ—Ä—É—Ç–∏–Ω–∞ –≤—Ö–æ–ª–æ—Å—Ç—É—é –∫—Ä—É—Ç–∏—Ç—Å—è –≤ —Ü–∏–∫–ª–µ, –ø–æ–∫–∞ —É—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ç–∞–Ω–µ—Ç `true`:

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

var (
	ready  bool
	mu     sync.Mutex
)

func worker() {
	for {
		mu.Lock()
		if ready {
			fmt.Println("–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
			mu.Unlock()
			return
		}
		mu.Unlock()
		// –ü–ª–æ—Ö–æ: –≥–æ—Ä—É—Ç–∏–Ω–∞ "—Å—ä–µ–¥–∞–µ—Ç" CPU, –ø–æ–∫–∞ –∂–¥—ë—Ç!
	}
}

func main() {
	go worker()
	time.Sleep(10 * time.Second) // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏

	mu.Lock()
	ready = true  // –í—Å—ë, —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
	mu.Unlock()

	time.Sleep(1 * time.Second) // –î–∞—ë–º worker'—É –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**:  
–ì–æ—Ä—É—Ç–∏–Ω–∞ `worker` **–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ —Ç—Ä–∞—Ç–∏—Ç CPU**, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—è `ready` (—ç—Ç–æ –≤–∏–¥–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –º–æ–Ω–∏—Ç–æ—Ä–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞).

##### –ü—Ä–∏–º–µ—Ä 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ `sync.Cond`)

–í–º–µ—Å—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º **—É—Å–ª–æ–≤–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é** (`sync.Cond`), —á—Ç–æ–±—ã –≥–æ—Ä—É—Ç–∏–Ω–∞ "—Å–ø–∞–ª–∞" –¥–æ —Å–æ–±—ã—Ç–∏—è:

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

var (
	ready bool
	cond  = sync.NewCond(&sync.Mutex{})
)

func worker() {
	cond.L.Lock()
	for !ready {
		cond.Wait() // –ì–æ—Ä—É—Ç–∏–Ω–∞ "—Å–ø–∏—Ç" –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç CPU
	}
	fmt.Println("–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
	cond.L.Unlock()
}

func main() {
	go worker()
	time.Sleep(10 * time.Second) // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏

	cond.L.Lock()
	ready = true
	cond.Signal() // –ë—É–¥–∏–º –≥–æ—Ä—É—Ç–∏–Ω—É
	cond.L.Unlock()

	time.Sleep(1 * time.Second)
}
```

###### –ü–æ—á–µ–º—É —Ç–∞–∫ –ª—É—á—à–µ?

- –ì–æ—Ä—É—Ç–∏–Ω–∞ **–Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç CPU** –≤ –æ–∂–∏–¥–∞–Ω–∏–∏.
- –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è** (—á–µ—Ä–µ–∑ `cond.Signal()`).

##### –ü—Ä–∏–º–µ—Ä 3: Busy Waiting —Å –∫–∞–Ω–∞–ª–æ–º (–ø–ª–æ—Ö–æ–π —Å—Ç–∏–ª—å)

–ò–Ω–æ–≥–¥–∞ Busy Waiting –º–∞—Å–∫–∏—Ä—É—é—Ç –ø–æ–¥ "–æ–ø—Ä–æ—Å –∫–∞–Ω–∞–ª–∞" (–Ω–æ —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ):

```go
func worker(stopChan chan bool) {
	for {
		select {
		case <-stopChan:  // –ï—Å–ª–∏ –≤ –∫–∞–Ω–∞–ª–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å ‚Äî –≤—ã—Ö–æ–¥–∏–º
			fmt.Println("–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
			return
		default:  // –ü–ª–æ—Ö–æ: —Ü–∏–∫–ª "–ø—É—Å—Ç–æ–≥–æ" –æ–ø—Ä–æ—Å–∞
		}
	}
}

func main() {
	stopChan := make(chan bool)
	go worker(stopChan)
	time.Sleep(1 * time.Second)
	stopChan <- true  // –ü–æ—Å—ã–ª–∞–µ–º —Å–∏–≥–Ω–∞–ª
	time.Sleep(1 * time.Second)
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**:  
–¶–∏–∫–ª —Å `select` –∏ `default` **—Ç–∞–∫ –∂–µ —Ç—Ä–∞—Ç–∏—Ç CPU**, –∫–∞–∫ –∏ –ø—Ä–æ—Å—Ç–æ–π `for` (—ç—Ç–æ –≤—Å—ë –µ—â—ë Busy Waiting).

#### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã**:
    - `sync.Cond` (—É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ).
    - –ö–∞–Ω–∞–ª—ã **–±–µ–∑ `default`** (–≥–æ—Ä—É—Ç–∏–Ω–∞ "—É—Å–Ω—ë—Ç", –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç –¥–∞–Ω–Ω—ã–µ).
    - `sync.Mutex` + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ (–Ω–æ –Ω–µ –≤ —Ü–∏–∫–ª–µ, –∞ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º).

- **–î–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á ‚Äî `time.Sleep` (–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ!)**:
```go
for !ready {
    time.Sleep(100 * time.Millisecond)  // –°–Ω–∏–∂–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ CPU
}
```

- **–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å ‚Äî –¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π**:
```go
ticker := time.NewTicker(500 * time.Millisecond)
for range ticker.C {  // –¢–∏–∫–µ—Ä –≤–º–µ—Å—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    if checkCondition() {
        break
    }
}
```

#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

|**–ú–µ—Ç–æ–¥**|**–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CPU**|**–†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ**|
|---|---|---|
|**Busy Waiting**|Ô∏èÔ∏è‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ|–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è|
|**`sync.Cond`**|–ù—É–ª–µ–≤–æ–µ (—Å–ø–∏—Ç)|–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è|
|**–ö–∞–Ω–∞–ª—ã**|–ù—É–ª–µ–≤–æ–µ (—Å–ø–∏—Ç)|–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è|
|**`time.Sleep`**|–ù–∏–∑–∫–æ–µ|–ó–∞–¥–µ—Ä–∂–∫–∞ (~100ms)|
|**Ticker (–æ–ø—Ä–æ—Å)**|–ù–∏–∑–∫–æ–µ|–ó–∞–¥–µ—Ä–∂–∫–∞ (–ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ)|

#### –í—ã–≤–æ–¥

- **Busy Waiting ‚Äî —ç—Ç–æ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω** (–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –≤—ã –Ω–µ –ø–∏—à–µ—Ç–µ –∫–æ–¥ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –≥–¥–µ –Ω–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞).
- –í Go –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å **–ª—É—á—à–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã**: `sync.Cond`, –∫–∞–Ω–∞–ª—ã, `time.Sleep` –∏–ª–∏ `time.Ticker`.
- –ï—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å ‚Äî **–ø—É—Å—Ç—å "—Å–ø–∏—Ç"**, –∞ –Ω–µ "–∫—Ä—É—Ç–∏—Ç—Å—è" –≤ —Ü–∏–∫–ª–µ!

**–ü—Ä–∞–≤–∏–ª–æ**:

> "–ï—Å–ª–∏ –≤–∞—à `for { ... }` –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç –≤ —Ü–∏–∫–ª–µ ‚Äî —ç—Ç–æ Busy Waiting. –ò—Å–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ!"  
> ‚Äî _–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏_

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–∞–Ω–∞–ª–∞–º–∏

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ `send/receive` –±–µ–∑ `default` –≤ `select`.

## –ö–∞–∫ –ø–∏—Å–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–¥?

1. **–ú—å—é—Ç–µ–∫—Å—ã –¥–ª—è –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö** (`sync.Mutex` –∏–ª–∏ `sync.RWMutex`).
2. **–ö–∞–Ω–∞–ª—ã –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏** (–ø—Ä–∏–Ω—Ü–∏–ø "Don't communicate by sharing memory, share memory by communicating").
3. **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ (`atomic.AddInt`).
4. **–î–µ—Ç–µ–∫—Ç–æ—Ä –≥–æ–Ω–æ–∫** (`go run --race`).
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –º–æ—â–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç–∏. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–æ–¥ –Ω–∞ –≥–æ–Ω–∫–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!


