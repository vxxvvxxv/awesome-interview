–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [The Go Memory Model](https://go.dev/ref/mem)

---

# Stack —É goroutine 

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Stack managment](https://www.sobyte.net/post/2021-12/golang-stack-management/)

## –ß—Ç–æ —Ç–∞–∫–æ–µ **—Å—Ç–µ–∫ —É goroutine**?

–ö–∞–∂–¥–∞—è `goroutine` –≤ Go –∏–º–µ–µ—Ç **—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–µ–∫** (stack) ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, –∫—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è:

- –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–π;
- –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è;
- –∞–¥—Ä–µ—Å –≤–æ–∑–≤—Ä–∞—Ç–∞ (`return addr`);
- –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

## –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã —Å—Ç–µ–∫–∏ –≤ Go?

### –°–µ–π—á–∞—Å: **Contiguous stacks** (–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ —Å—Ç–µ–∫–∏)

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Contiguous stacks](https://docs.google.com/document/u/0/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/mobilebasic)

**–° –≤–µ—Ä—Å–∏–∏ Go 1.4** (_–∏ –¥–æ —Å–µ–≥–æ–¥–Ω—è_) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **contiguous stack model**.

**Segmented stack** ‚Äî —ç—Ç–æ –º–æ–¥–µ–ª—å —Å—Ç–µ–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π **—Å—Ç–µ–∫ goroutine —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã** (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–∞–º—è—Ç–∏).  
–ö–æ–≥–¥–∞ —Å—Ç–µ–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ **–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç**, –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–≤—ã–¥–µ–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ –±–ª–æ–∫–∞.

- –≠—Ç–æ **–µ–¥–∏–Ω—ã–π –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –±–ª–æ–∫ –ø–∞–º—è—Ç–∏**, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å—Ç—ë—Ç –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ ‚Äî —Å—Ç–µ–∫ **–ø–µ—Ä–µ–≤—ã–¥–µ–ª—è–µ—Ç—Å—è** (copy + grow)
- –°—Ç–∞—Ä—ã–π —Å—Ç–µ–∫ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–æ–≤—ã–π –∏ GC –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏.

#### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ö–∞–∂–¥–∞—è goroutine **–Ω–∞—á–∏–Ω–∞–µ—Ç —Å –Ω–µ–±–æ–ª—å—à–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2 KB)
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏:
    - –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–º —Å–µ–≥–º–µ–Ω—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî
	    - **—Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç**
	    - —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤ **–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è** –≤ –Ω–æ–≤–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ
- –ö–æ–≥–¥–∞ —Å–µ–≥–º–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –æ–Ω **—É–¥–∞–ª—è–µ—Ç—Å—è** (pop)

–≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ **—Å–≤—è–∑–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤**:

```go
Segment 1 ‚Üí Segment 2 ‚Üí Segment 3 ...
```

#### –ü–ª—é—Å—ã segmented stack

|–ü–ª—é—Å|–û–±—ä—è—Å–Ω–µ–Ω–∏–µ|
|---|---|
|ü™∂ –õ—ë–≥–∫–∏–π —Å—Ç–∞—Ä—Ç|–û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä|
|üí° –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏|
|üß© –ü—Ä–æ—Å—Ç–æ–π —Ä–æ—Å—Ç|–ù–µ –Ω—É–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç|

#### –ú–∏–Ω—É—Å—ã segmented stack

|–ú–∏–Ω—É—Å|–û–±—ä—è—Å–Ω–µ–Ω–∏–µ|
|---|---|
|üê¢ –ú–µ–¥–ª–µ–Ω–Ω–µ–µ|–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ö–≤–∞—Ç–∏—Ç –ª–∏ –º–µ—Å—Ç–∞|
|üîÑ –°–ª–æ–∂–Ω–µ–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏|–ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ –¥–µ–ª–∞—é—Ç —Å—Ç–µ–∫ –º–µ–Ω–µ–µ —á–∏—Ç–∞–µ–º—ã–º|
|ü§ñ GC —Å–ª–æ–∂–Ω–µ–µ|–¢—Ä—É–¥–Ω–µ–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∞—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª–∏ –º–µ–∂–¥—É —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏|
|üí• –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤ "–≥–æ—Ä—è—á–µ–º" –∫–æ–¥–µ|–û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ –∏–ª–∏ —á–∞—Å—Ç–æ–º –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–π|

### –†–∞–Ω—å—à–µ: **Segmented stack** (–¥–æ Go 1.3)

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Need help understanding segmented stack and stack splitting ](https://golang-nuts.narkive.com/xfWAIezk/need-help-understanding-segmented-stack-and-stack-splitting)


- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –º–æ–¥–µ–ª—å **—Ä–∞–∑–±–∏—Ç—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤**, –∫–∞–∂–¥—ã–π —Å—Ç–µ–∫ ‚Äî —ç—Ç–æ —Ü–µ–ø–æ—á–∫–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö –±–ª–æ–∫–æ–≤.
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–ª—Å—è –Ω–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç.
- –ù–æ: **–º–Ω–æ–≥–æ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤**, –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π.

–ü–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ contiguous ‚Äî –æ–Ω –±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–æ—â–µ –∏ –ª—É—á—à–µ –¥–ª—è GC.

### –ü–æ—á–µ–º—É Go –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç Segmented Stack

Go –¥–æ –≤–µ—Ä—Å–∏–∏ **1.3** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª segmented stack (inspired by LLVM), –Ω–æ:

–ù–∞—á–∏–Ω–∞—è —Å **Go 1.4**, –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—à–ª–∞ –Ω–∞ **contiguous stacks** ‚Äî –∏ –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç segmented stack.

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:  
> **Contiguous stack –ø—Ä–æ—â–µ, –±—ã—Å—Ç—Ä–µ–µ, –∏ –ª—É—á—à–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã GC –∏ inlining'–∞**.

## –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å—Ç–µ–∫ goroutine?

- –í **–∫—É—á–µ (heap)**, –∞ –Ω–µ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å—Ç–µ–∫–µ –ø–æ—Ç–æ–∫–∞ –û–°!
- –ö–∞–∂–¥—ã–π `G` (goroutine) —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –Ω–∞—á–∞–ª–æ —Å–≤–æ–µ–≥–æ —Å—Ç–µ–∫–∞ (`g.stack`).
- –í–Ω—É—Ç—Ä–∏ —Ä–∞–Ω—Ç–∞–π–º–∞ —Å—Ç–µ–∫ –ª–µ–∂–∏—Ç –≤ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏, —É–ø—Ä–∞–≤–ª—è–µ–º–æ–π **—Å–∞–º–∏–º Go**.

## –° –∫–∞–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏ –∫–∞–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Ç—ë—Ç

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [Go: –∫–∞–∫ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞ –≥–æ—Ä—É—Ç–∏–Ω—ã?](https://habr.com/ru/companies/otus/articles/586108/)
- [How Stacks are Handled in Go](https://blog.cloudflare.com/how-stacks-are-handled-in-go/)

- –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: **2 KB** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`stackSmall`).
- –û–Ω **—Ä–∞—Å—Ç—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** –¥–æ **1 MB** (–∏–ª–∏ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ –Ω–∞–¥–æ).
- –†–∞—Å—Ç—ë—Ç **–≤–¥–≤–æ–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ (2KB ‚Üí 4KB ‚Üí 8KB ‚Üí ‚Ä¶).

### –ö–∞–∫ —Å—Ç–µ–∫ —Ä–∞—Å—Ç—ë—Ç

Go –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –Ω–µ –ø—Ä–∏–±–ª–∏–∑–∏–ª—Å—è –ª–∏ —Å—Ç–µ–∫ –∫ ‚Äú–≥—Ä–∞–Ω–∏—Ü–µ‚Äù —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º:

```go
if sp < g.stackguard {
    morestack() // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ä–∞–Ω—Ç–∞–π–º–æ–º, —Å—Ç–µ–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
}
```

- `g.stackguard` ‚Äî "–≥—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–µ–∫–∞"
- –ï—Å–ª–∏ —Å—Ç–µ–∫ –ø–æ—á—Ç–∏ –∏—Å—á–µ—Ä–ø–∞–Ω ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `morestack`, –∏ —Å—Ç–µ–∫ **—Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è**
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ –Ω–æ–≤—ã–π —Å—Ç–µ–∫, –∏ GC **–ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª–∏**

**–í–∞–∂–Ω–æ**: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ **–ø—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**, –Ω–æ —Å—Ç–æ–∏—Ç –∏–∑–±–µ–≥–∞—Ç—å —Å–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏.

### –ö–∞–∫ —Å—Ç–µ–∫ –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å—Å—è

- –ï—Å–ª–∏ goroutine –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å ‚Äî –µ—ë —Å—Ç–µ–∫ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª –ø–∞–º—è—Ç–∏**
- –ï—Å–ª–∏ —Å—Ç–µ–∫ **–≤—ã—Ä–æ—Å —Å–∏–ª—å–Ω–æ**, –Ω–æ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞–ª–æ ‚Äî –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å **—É—Å–µ—á—ë–Ω** (shrink) GC-–æ–º.

## –ß—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å—Ç–µ–∫ goroutine

–í —Å—Ç–µ–∫ –ø–æ–ø–∞–¥–∞—é—Ç:

- **–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** (`x := 5`)
- **–ê—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏**
- **–ë—É—Ñ–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ–±–æ–ª—å—à–∏–µ**
- **–£–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ heap**, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è "–≤—ã—Ä–æ—Å–ª–∞"

–ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç:

- –í—Å—ë, —á—Ç–æ **–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ –∏ –º–æ–∂–µ—Ç ‚Äú–≤—ã—Ä–≤–∞—Ç—å—Å—è‚Äù –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî —ç—Ç–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `heap` (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑–æ–º escape).

## –ö–∞–∫ —É–≤–∏–¥–µ—Ç—å —Å—Ç–µ–∫

–ú–æ–∂–µ–º –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–µ–∫ goroutine —á–µ—Ä–µ–∑:

```go
runtime.Stack(buf []byte, all bool)
```

–∏–ª–∏ –≤ –æ—Ç–ª–∞–¥—á–∏–∫–µ / panic trace:

```go
goroutine 1 [running]:
main.main()
    /main.go:6 +0x20
```

# –ê–ª–ª–æ–∫–∞—Ç–æ—Ä –≤ Go

TODO

## –ö–∞–∫ –æ–Ω –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å?

TODO

